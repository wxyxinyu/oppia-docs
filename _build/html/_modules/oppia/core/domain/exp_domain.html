<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>oppia.core.domain.exp_domain &mdash; Oppia rc4 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     'rc4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Oppia rc4 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for oppia.core.domain.exp_domain</h1><div class="highlight"><pre>
<span class="c"># coding: utf-8</span>
<span class="c">#</span>
<span class="c"># Copyright 2014 The Oppia Authors. All Rights Reserved.</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Domain objects for an exploration, its states, and their constituents.</span>

<span class="sd">Domain objects capture domain-specific logic and are agnostic of how the</span>
<span class="sd">objects they represent are stored. All methods and properties in this file</span>
<span class="sd">should therefore be independent of the specific storage models used.&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Sean Lip&#39;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="kn">from</span> <span class="nn">core.domain</span> <span class="kn">import</span> <span class="n">fs_domain</span>
<span class="kn">from</span> <span class="nn">core.domain</span> <span class="kn">import</span> <span class="n">html_cleaner</span>
<span class="kn">from</span> <span class="nn">core.domain</span> <span class="kn">import</span> <span class="n">gadget_registry</span>
<span class="kn">from</span> <span class="nn">core.domain</span> <span class="kn">import</span> <span class="n">interaction_registry</span>
<span class="kn">from</span> <span class="nn">core.domain</span> <span class="kn">import</span> <span class="n">param_domain</span>
<span class="kn">from</span> <span class="nn">core.domain</span> <span class="kn">import</span> <span class="n">rule_domain</span>
<span class="kn">from</span> <span class="nn">core.domain</span> <span class="kn">import</span> <span class="n">skins_services</span>
<span class="kn">from</span> <span class="nn">core.domain</span> <span class="kn">import</span> <span class="n">trigger_registry</span>
<span class="kn">import</span> <span class="nn">feconf</span>
<span class="kn">import</span> <span class="nn">jinja_utils</span>
<span class="kn">import</span> <span class="nn">utils</span>


<span class="c"># Do not modify the values of these constants. This is to preserve backwards</span>
<span class="c"># compatibility with previous change dicts.</span>
<span class="c"># TODO(bhenning): Prior to July 2015, exploration changes involving rules were</span>
<span class="c"># logged using the key &#39;widget_handlers&#39;. These need to be migrated to</span>
<span class="c"># &#39;answer_groups&#39; and &#39;default_outcome&#39;.</span>
<span class="n">STATE_PROPERTY_PARAM_CHANGES</span> <span class="o">=</span> <span class="s">&#39;param_changes&#39;</span>
<span class="n">STATE_PROPERTY_CONTENT</span> <span class="o">=</span> <span class="s">&#39;content&#39;</span>
<span class="n">STATE_PROPERTY_INTERACTION_ID</span> <span class="o">=</span> <span class="s">&#39;widget_id&#39;</span>
<span class="n">STATE_PROPERTY_INTERACTION_CUST_ARGS</span> <span class="o">=</span> <span class="s">&#39;widget_customization_args&#39;</span>
<span class="n">STATE_PROPERTY_INTERACTION_ANSWER_GROUPS</span> <span class="o">=</span> <span class="s">&#39;answer_groups&#39;</span>
<span class="n">STATE_PROPERTY_INTERACTION_DEFAULT_OUTCOME</span> <span class="o">=</span> <span class="s">&#39;default_outcome&#39;</span>
<span class="c"># These two properties are kept for legacy purposes and are not used anymore.</span>
<span class="n">STATE_PROPERTY_INTERACTION_HANDLERS</span> <span class="o">=</span> <span class="s">&#39;widget_handlers&#39;</span>
<span class="n">STATE_PROPERTY_INTERACTION_STICKY</span> <span class="o">=</span> <span class="s">&#39;widget_sticky&#39;</span>

<span class="c"># This takes an additional &#39;state_name&#39; parameter.</span>
<span class="n">CMD_ADD_STATE</span> <span class="o">=</span> <span class="s">&#39;add_state&#39;</span>
<span class="c"># This takes additional &#39;old_state_name&#39; and &#39;new_state_name&#39; parameters.</span>
<span class="n">CMD_RENAME_STATE</span> <span class="o">=</span> <span class="s">&#39;rename_state&#39;</span>
<span class="c"># This takes an additional &#39;state_name&#39; parameter.</span>
<span class="n">CMD_DELETE_STATE</span> <span class="o">=</span> <span class="s">&#39;delete_state&#39;</span>
<span class="c"># This takes additional &#39;property_name&#39; and &#39;new_value&#39; parameters.</span>
<span class="n">CMD_EDIT_STATE_PROPERTY</span> <span class="o">=</span> <span class="s">&#39;edit_state_property&#39;</span>
<span class="c"># This takes additional &#39;property_name&#39; and &#39;new_value&#39; parameters.</span>
<span class="n">CMD_EDIT_EXPLORATION_PROPERTY</span> <span class="o">=</span> <span class="s">&#39;edit_exploration_property&#39;</span>
<span class="c"># This takes additional &#39;from_version&#39; and &#39;to_version&#39; parameters for logging.</span>
<span class="n">CMD_MIGRATE_STATES_SCHEMA_TO_LATEST_VERSION</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;migrate_states_schema_to_latest_version&#39;</span><span class="p">)</span>

<span class="c"># This represents the stringified version of a &#39;default rule.&#39; This is to be</span>
<span class="c"># used as an identifier for the default rule when storing which rule an answer</span>
<span class="c"># was matched against.</span>
<span class="n">DEFAULT_RULESPEC_STR</span> <span class="o">=</span> <span class="s">&#39;Default&#39;</span>


<span class="k">def</span> <span class="nf">_get_full_customization_args</span><span class="p">(</span><span class="n">customization_args</span><span class="p">,</span> <span class="n">ca_specs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Populates the given customization_args dict with default values</span>
<span class="sd">    if any of the expected customization_args are missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ca_spec</span> <span class="ow">in</span> <span class="n">ca_specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ca_spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">customization_args</span><span class="p">:</span>
            <span class="n">customization_args</span><span class="p">[</span><span class="n">ca_spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="n">ca_spec</span><span class="o">.</span><span class="n">default_value</span>
            <span class="p">}</span>
    <span class="k">return</span> <span class="n">customization_args</span>


<span class="k">def</span> <span class="nf">_validate_customization_args_and_values</span><span class="p">(</span>
        <span class="n">item_name</span><span class="p">,</span> <span class="n">item_type</span><span class="p">,</span> <span class="n">customization_args</span><span class="p">,</span>
        <span class="n">ca_specs_to_validate_against</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates the given `customization_args` dict against the specs set out</span>
<span class="sd">    in `ca_specs_to_validate_against`.</span>

<span class="sd">    The item_name is either &#39;interaction&#39;, &#39;gadget&#39; or &#39;trigger&#39;, and the</span>
<span class="sd">    item_type is the id/type of the interaction/gadget/trigger, respectively.</span>
<span class="sd">    These strings are used to populate any error messages that arise during</span>
<span class="sd">    validation.</span>

<span class="sd">    Note that this may modify the given customization_args dict, if it has</span>
<span class="sd">    extra or missing keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ca_spec_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ca_spec</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">ca_spec</span> <span class="ow">in</span> <span class="n">ca_specs_to_validate_against</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">customization_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">&#39;Expected customization args to be a dict, received </span><span class="si">%s</span><span class="s">&#39;</span>
            <span class="o">%</span> <span class="n">customization_args</span><span class="p">)</span>

    <span class="c"># Validate and clean up the customization args.</span>

    <span class="c"># Populate missing keys with the default values.</span>
    <span class="n">customization_args</span> <span class="o">=</span> <span class="n">_get_full_customization_args</span><span class="p">(</span>
        <span class="n">customization_args</span><span class="p">,</span> <span class="n">ca_specs_to_validate_against</span><span class="p">)</span>

    <span class="c"># Remove extra keys.</span>
    <span class="n">extra_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">customization_args</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Invalid customization arg name: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">arg_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arg_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ca_spec_names</span><span class="p">:</span>
            <span class="n">extra_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_name</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> does not support customization arg </span><span class="si">%s</span><span class="s">.&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">item_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="n">item_type</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">extra_arg</span> <span class="ow">in</span> <span class="n">extra_args</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">customization_args</span><span class="p">[</span><span class="n">extra_arg</span><span class="p">]</span>

    <span class="c"># Check that each value has the correct type.</span>
    <span class="k">for</span> <span class="n">ca_spec</span> <span class="ow">in</span> <span class="n">ca_specs_to_validate_against</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">schema_utils</span><span class="o">.</span><span class="n">normalize_against_schema</span><span class="p">(</span>
                <span class="n">customization_args</span><span class="p">[</span><span class="n">ca_spec</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">],</span>
                <span class="n">ca_spec</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># TODO(sll): Raise an actual exception here if parameters are not</span>
            <span class="c"># involved. (If they are, can we get sample values for the state</span>
            <span class="c"># context parameters?)</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            logging.error(</span>
<span class="sd">                &#39;Validation error for customization arg %s: value %s does not &#39;</span>
<span class="sd">                &#39;match schema %s.&#39; % (</span>
<span class="sd">                    ca_spec.name,</span>
<span class="sd">                    unicode(customization_args[ca_spec.name][&#39;value&#39;]),</span>
<span class="sd">                    ca_spec.schema))</span>
<span class="sd">            &quot;&quot;&quot;</span>


<div class="viewcode-block" id="ExplorationChange"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.ExplorationChange">[docs]</a><span class="k">class</span> <span class="nc">ExplorationChange</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Domain object class for an exploration change.</span>

<span class="sd">    IMPORTANT: Ensure that all changes to this class (and how these cmds are</span>
<span class="sd">    interpreted in general) preserve backward-compatibility with the</span>
<span class="sd">    exploration snapshots in the datastore. Do not modify the definitions of</span>
<span class="sd">    cmd keys that already exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">STATE_PROPERTIES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">STATE_PROPERTY_PARAM_CHANGES</span><span class="p">,</span>
        <span class="n">STATE_PROPERTY_CONTENT</span><span class="p">,</span>
        <span class="n">STATE_PROPERTY_INTERACTION_ID</span><span class="p">,</span>
        <span class="n">STATE_PROPERTY_INTERACTION_CUST_ARGS</span><span class="p">,</span>
        <span class="n">STATE_PROPERTY_INTERACTION_STICKY</span><span class="p">,</span>
        <span class="n">STATE_PROPERTY_INTERACTION_HANDLERS</span><span class="p">,</span>
        <span class="n">STATE_PROPERTY_INTERACTION_ANSWER_GROUPS</span><span class="p">,</span>
        <span class="n">STATE_PROPERTY_INTERACTION_DEFAULT_OUTCOME</span><span class="p">)</span>

    <span class="n">EXPLORATION_PROPERTIES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;category&#39;</span><span class="p">,</span> <span class="s">&#39;objective&#39;</span><span class="p">,</span> <span class="s">&#39;language_code&#39;</span><span class="p">,</span> <span class="s">&#39;tags&#39;</span><span class="p">,</span>
        <span class="s">&#39;blurb&#39;</span><span class="p">,</span> <span class="s">&#39;author_notes&#39;</span><span class="p">,</span> <span class="s">&#39;param_specs&#39;</span><span class="p">,</span> <span class="s">&#39;param_changes&#39;</span><span class="p">,</span>
        <span class="s">&#39;default_skin_id&#39;</span><span class="p">,</span> <span class="s">&#39;init_state_name&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes an ExplorationChange object from a dict.</span>

<span class="sd">        change_dict represents a command. It should have a &#39;cmd&#39; key, and one</span>
<span class="sd">        or more other keys. The keys depend on what the value for &#39;cmd&#39; is.</span>

<span class="sd">        The possible values for &#39;cmd&#39; are listed below, together with the other</span>
<span class="sd">        keys in the dict:</span>
<span class="sd">        - &#39;add_state&#39; (with state_name)</span>
<span class="sd">        - &#39;rename_state&#39; (with old_state_name and new_state_name)</span>
<span class="sd">        - &#39;delete_state&#39; (with state_name)</span>
<span class="sd">        - &#39;edit_state_property&#39; (with state_name, property_name, new_value and,</span>
<span class="sd">            optionally, old_value)</span>
<span class="sd">        - &#39;edit_exploration_property&#39; (with property_name, new_value and,</span>
<span class="sd">            optionally, old_value)</span>
<span class="sd">        - &#39;migrate_states_schema&#39; (with from_version and to_version)</span>

<span class="sd">        For a state, property_name must be one of STATE_PROPERTIES. For an</span>
<span class="sd">        exploration, property_name must be one of EXPLORATION_PROPERTIES.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;cmd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">change_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid change_dict: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">change_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;cmd&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CMD_ADD_STATE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_name</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;state_name&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CMD_RENAME_STATE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_state_name</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;old_state_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_state_name</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;new_state_name&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CMD_DELETE_STATE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_name</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;state_name&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CMD_EDIT_STATE_PROPERTY</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;property_name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATE_PROPERTIES</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid change_dict: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">change_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_name</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;state_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">property_name</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;property_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_value</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;new_value&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">=</span> <span class="n">change_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;old_value&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CMD_EDIT_EXPLORATION_PROPERTY</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;property_name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">EXPLORATION_PROPERTIES</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid change_dict: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">change_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">property_name</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;property_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_value</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;new_value&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">=</span> <span class="n">change_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;old_value&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CMD_MIGRATE_STATES_SCHEMA_TO_LATEST_VERSION</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_version</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;from_version&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_version</span> <span class="o">=</span> <span class="n">change_dict</span><span class="p">[</span><span class="s">&#39;to_version&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid change_dict: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">change_dict</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ExplorationCommitLogEntry"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.ExplorationCommitLogEntry">[docs]</a><span class="k">class</span> <span class="nc">ExplorationCommitLogEntry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Value object representing a commit to an exploration.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">created_on</span><span class="p">,</span> <span class="n">last_updated</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">exploration_id</span><span class="p">,</span>
            <span class="n">commit_type</span><span class="p">,</span> <span class="n">commit_message</span><span class="p">,</span> <span class="n">commit_cmds</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span>
            <span class="n">post_commit_status</span><span class="p">,</span> <span class="n">post_commit_community_owned</span><span class="p">,</span>
            <span class="n">post_commit_is_private</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_on</span> <span class="o">=</span> <span class="n">created_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">last_updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploration_id</span> <span class="o">=</span> <span class="n">exploration_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit_type</span> <span class="o">=</span> <span class="n">commit_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit_message</span> <span class="o">=</span> <span class="n">commit_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit_cmds</span> <span class="o">=</span> <span class="n">commit_cmds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_commit_status</span> <span class="o">=</span> <span class="n">post_commit_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_commit_community_owned</span> <span class="o">=</span> <span class="n">post_commit_community_owned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_commit_is_private</span> <span class="o">=</span> <span class="n">post_commit_is_private</span>

<div class="viewcode-block" id="ExplorationCommitLogEntry.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.ExplorationCommitLogEntry.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This omits created_on, user_id and (for now) commit_cmds.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;last_updated&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_time_in_millisecs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_updated</span><span class="p">),</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">&#39;exploration_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploration_id</span><span class="p">,</span>
            <span class="s">&#39;commit_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_type</span><span class="p">,</span>
            <span class="s">&#39;commit_message&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_message</span><span class="p">,</span>
            <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="s">&#39;post_commit_status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_commit_status</span><span class="p">,</span>
            <span class="s">&#39;post_commit_community_owned&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_commit_community_owned</span><span class="p">,</span>
            <span class="s">&#39;post_commit_is_private&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_commit_is_private</span><span class="p">,</span>
        <span class="p">}</span>

</div></div>
<div class="viewcode-block" id="Content"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Content">[docs]</a><span class="k">class</span> <span class="nc">Content</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Value object representing non-interactive content.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Content.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Content.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Content.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Content.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">content_dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">content_dict</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">],</span> <span class="n">content_dict</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">content_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">html_cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

<div class="viewcode-block" id="Content.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Content.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># TODO(sll): Add HTML sanitization checking.</span>
        <span class="c"># TODO(sll): Validate customization args for rich-text components.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&#39;text&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Invalid content type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Invalid content value: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Content.to_html"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Content.to_html">[docs]</a>    <span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exports this content object to an HTML string.</span>

<span class="sd">        The content object is parameterized using the parameters in `params`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&#39;Expected context params for parsing content to be a dict, &#39;</span>
                <span class="s">&#39;received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">html_cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">jinja_utils</span><span class="o">.</span><span class="n">parse_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="RuleSpec"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.RuleSpec">[docs]</a><span class="k">class</span> <span class="nc">RuleSpec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Value object representing a rule specification.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RuleSpec.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.RuleSpec.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;rule_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_type</span><span class="p">,</span>
            <span class="s">&#39;inputs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
        <span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="RuleSpec.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.RuleSpec.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">rulespec_dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">rulespec_dict</span><span class="p">[</span><span class="s">&#39;rule_type&#39;</span><span class="p">],</span>
            <span class="n">rulespec_dict</span><span class="p">[</span><span class="s">&#39;inputs&#39;</span><span class="p">]</span>
        <span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_type</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule_type</span> <span class="o">=</span> <span class="n">rule_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>

<div class="viewcode-block" id="RuleSpec.stringify_classified_rule"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.RuleSpec.stringify_classified_rule">[docs]</a>    <span class="k">def</span> <span class="nf">stringify_classified_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a string representation of a rule (for the stats log).&quot;&quot;&quot;</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">to_ascii</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span>
                      <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_type</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_list</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="RuleSpec.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.RuleSpec.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_params_list</span><span class="p">,</span> <span class="n">exp_param_specs_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates a RuleSpec value object. It ensures the inputs dict does</span>
<span class="sd">        not refer to any non-existent parameters and that it contains values</span>
<span class="sd">        for all the parameters the rule expects.</span>

<span class="sd">        Args:</span>
<span class="sd">            rule_params_list: A list of parameters used by the rule represented</span>
<span class="sd">                by this RuleSpec instance, to be used to validate the inputs of</span>
<span class="sd">                this RuleSpec. Each element of the list represents a single</span>
<span class="sd">                parameter and is a tuple with two elements:</span>
<span class="sd">                    0: The name (string) of the parameter.</span>
<span class="sd">                    1: The typed object instance for that paramter (e.g. Real).</span>
<span class="sd">            exp_param_specs_dict: A dict of specified parameters used in this</span>
<span class="sd">                exploration. Keys are parameter names and values are ParamSpec</span>
<span class="sd">                value objects with an object type property (obj_type). RuleSpec</span>
<span class="sd">                inputs may have a parameter value which refers to one of these</span>
<span class="sd">                exploration parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected inputs to be a dict, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">input_key_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">param_names_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">rule_params_list</span><span class="p">])</span>
        <span class="n">leftover_input_keys</span> <span class="o">=</span> <span class="n">input_key_set</span> <span class="o">-</span> <span class="n">param_names_set</span>
        <span class="n">leftover_param_names</span> <span class="o">=</span> <span class="n">param_names_set</span> <span class="o">-</span> <span class="n">input_key_set</span>

        <span class="c"># Check if there are input keys which are not rule parameters.</span>
        <span class="k">if</span> <span class="n">leftover_input_keys</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s">&#39;RuleSpec </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> has inputs which are not recognized &#39;</span>
                <span class="s">&#39;parameter names: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_type</span><span class="p">,</span> <span class="n">leftover_input_keys</span><span class="p">))</span>

        <span class="c"># Check if there are missing parameters.</span>
        <span class="k">if</span> <span class="n">leftover_param_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;RuleSpec </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is missing inputs: </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_type</span><span class="p">,</span> <span class="n">leftover_param_names</span><span class="p">))</span>

        <span class="n">rule_params_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">rule_params_list</span><span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">param_value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">param_obj</span> <span class="o">=</span> <span class="n">rule_params_dict</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
            <span class="c"># Validate the parameter type given the value.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;{{&#39;</span> <span class="ow">in</span> <span class="n">param_value</span><span class="p">:</span>
                <span class="c"># Value refers to a parameter spec. Cross-validate the type of</span>
                <span class="c"># the parameter spec with the rule parameter.</span>
                <span class="n">start_brace_index</span> <span class="o">=</span> <span class="n">param_value</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;{{&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="n">end_brace_index</span> <span class="o">=</span> <span class="n">param_value</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;}}&#39;</span><span class="p">)</span>
                <span class="n">param_spec_name</span> <span class="o">=</span> <span class="n">param_value</span><span class="p">[</span>
                    <span class="n">start_brace_index</span><span class="p">:</span><span class="n">end_brace_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">param_spec_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exp_param_specs_dict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                        <span class="s">&#39;RuleSpec </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> has an input with name </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> which &#39;</span>
                        <span class="s">&#39;refers to an unknown parameter within the &#39;</span>
                        <span class="s">&#39;exploration: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">rule_type</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_spec_name</span><span class="p">))</span>
                <span class="c"># TODO(bhenning): The obj_type of the param_spec</span>
                <span class="c"># (exp_param_specs_dict[param_spec_name]) should be validated</span>
                <span class="c"># to be the same as param_obj.__name__ to ensure the rule spec</span>
                <span class="c"># can accept the type of the parameter.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Otherwise, a simple parameter value needs to be normalizable</span>
                <span class="c"># by the parameter object in order to be valid.</span>
                <span class="n">param_obj</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Outcome"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Outcome">[docs]</a><span class="k">class</span> <span class="nc">Outcome</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Value object representing an outcome of an interaction. An outcome</span>
<span class="sd">    consists of a destination state, feedback to show the user, and any</span>
<span class="sd">    parameter changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Outcome.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Outcome.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;dest&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span>
            <span class="s">&#39;feedback&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">,</span>
            <span class="s">&#39;param_changes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">param_change</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                              <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">],</span>
        <span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Outcome.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Outcome.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">outcome_dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">outcome_dict</span><span class="p">[</span><span class="s">&#39;dest&#39;</span><span class="p">],</span>
            <span class="n">outcome_dict</span><span class="p">[</span><span class="s">&#39;feedback&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="n">param_domain</span><span class="o">.</span><span class="n">ParamChange</span><span class="p">(</span>
                <span class="n">param_change</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">param_change</span><span class="p">[</span><span class="s">&#39;generator_id&#39;</span><span class="p">],</span>
                <span class="n">param_change</span><span class="p">[</span><span class="s">&#39;customization_args&#39;</span><span class="p">])</span>
             <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="n">outcome_dict</span><span class="p">[</span><span class="s">&#39;param_changes&#39;</span><span class="p">]],</span>
        <span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">feedback</span><span class="p">,</span> <span class="n">param_changes</span><span class="p">):</span>
        <span class="c"># Id of the destination state.</span>
        <span class="c"># TODO(sll): Check that this state actually exists.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span>
        <span class="c"># Feedback to give the reader if this rule is triggered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span> <span class="o">=</span> <span class="n">feedback</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">html_cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">feedback_item</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">feedback_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">]</span>
        <span class="c"># Exploration-level parameter changes to make if this rule is</span>
        <span class="c"># triggered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span> <span class="o">=</span> <span class="n">param_changes</span> <span class="ow">or</span> <span class="p">[]</span>

<div class="viewcode-block" id="Outcome.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Outcome.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Every outcome should have a destination.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected outcome dest to be a string, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected outcome feedback to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feedback_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feedback</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feedback_item</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Expected outcome feedback item to be a string, received &#39;</span>
                    <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">feedback_item</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected outcome param_changes to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">:</span>
            <span class="n">param_change</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="AnswerGroup"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.AnswerGroup">[docs]</a><span class="k">class</span> <span class="nc">AnswerGroup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Value object for an answer group. Answer groups represent a set of rules</span>
<span class="sd">    dictating whether a shared feedback should be shared with the user. These</span>
<span class="sd">    rules are ORed together. Answer groups may also support fuzzy/implicit</span>
<span class="sd">    rules that involve soft matching of answers to a set of training data</span>
<span class="sd">    and/or example answers dictated by the creator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AnswerGroup.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.AnswerGroup.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;rule_specs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rule_spec</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                           <span class="k">for</span> <span class="n">rule_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_specs</span><span class="p">],</span>
            <span class="s">&#39;outcome&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AnswerGroup.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.AnswerGroup.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">answer_group_dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">Outcome</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">answer_group_dict</span><span class="p">[</span><span class="s">&#39;outcome&#39;</span><span class="p">]),</span>
            <span class="p">[</span><span class="n">RuleSpec</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">answer_group_dict</span><span class="p">[</span><span class="s">&#39;rule_specs&#39;</span><span class="p">]],</span>
        <span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">rule_specs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule_specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">RuleSpec</span><span class="p">(</span>
            <span class="n">rule_spec</span><span class="o">.</span><span class="n">rule_type</span><span class="p">,</span> <span class="n">rule_spec</span><span class="o">.</span><span class="n">inputs</span>
        <span class="p">)</span> <span class="k">for</span> <span class="n">rule_spec</span> <span class="ow">in</span> <span class="n">rule_specs</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span> <span class="o">=</span> <span class="n">outcome</span>

<div class="viewcode-block" id="AnswerGroup.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.AnswerGroup.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">,</span> <span class="n">exp_param_specs_dict</span><span class="p">):</span>
        <span class="c"># Rule validation.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_specs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected answer group rules to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_specs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule_specs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;There must be at least one rule for each answer group.&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_specs</span><span class="p">)</span>

        <span class="n">all_rule_classes</span> <span class="o">=</span> <span class="n">rule_domain</span><span class="o">.</span><span class="n">get_rules_for_obj_type</span><span class="p">(</span><span class="n">obj_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rule_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_specs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rule_class</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_rule_classes</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="n">rule_spec</span><span class="o">.</span><span class="n">rule_type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Unrecognized rule type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">rule_spec</span><span class="o">.</span><span class="n">rule_type</span><span class="p">)</span>

            <span class="n">rule_spec</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span>
                <span class="n">rule_domain</span><span class="o">.</span><span class="n">get_param_list</span><span class="p">(</span><span class="n">rule_class</span><span class="o">.</span><span class="n">description</span><span class="p">),</span>
                <span class="n">exp_param_specs_dict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="TriggerInstance"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.TriggerInstance">[docs]</a><span class="k">class</span> <span class="nc">TriggerInstance</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Value object representing a trigger.</span>

<span class="sd">    A trigger refers to a condition that may arise during a learner</span>
<span class="sd">    playthrough, such as a certain number of loop-arounds on the current state,</span>
<span class="sd">    or a certain amount of time having elapsed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_type</span><span class="p">,</span> <span class="n">customization_args</span><span class="p">):</span>
        <span class="c"># A string denoting the type of trigger.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_type</span> <span class="o">=</span> <span class="n">trigger_type</span>
        <span class="c"># Customization args for the trigger. This is a dict: the keys and</span>
        <span class="c"># values are the names of the customization_args for this trigger</span>
        <span class="c"># type, and the corresponding values for this instance of the trigger,</span>
        <span class="c"># respectively. The values consist of standard Python/JSON data types</span>
        <span class="c"># (i.e. strings, ints, booleans, dicts and lists, but not objects).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span> <span class="o">=</span> <span class="n">customization_args</span>

<div class="viewcode-block" id="TriggerInstance.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.TriggerInstance.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;trigger_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_type</span><span class="p">,</span>
            <span class="s">&#39;customization_args&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span><span class="p">,</span>
        <span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TriggerInstance.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.TriggerInstance.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">trigger_dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">trigger_dict</span><span class="p">[</span><span class="s">&#39;trigger_type&#39;</span><span class="p">],</span>
            <span class="n">trigger_dict</span><span class="p">[</span><span class="s">&#39;customization_args&#39;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="TriggerInstance.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.TriggerInstance.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger_type</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected trigger type to be a string, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_type</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger_registry</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_trigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger_type</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Unknown trigger type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_type</span><span class="p">)</span>

        <span class="c"># Verify that the customization args are valid.</span>
        <span class="n">_validate_customization_args_and_values</span><span class="p">(</span>
            <span class="s">&#39;trigger&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span><span class="p">,</span>
            <span class="n">trigger</span><span class="o">.</span><span class="n">customization_arg_specs</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Fallback"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Fallback">[docs]</a><span class="k">class</span> <span class="nc">Fallback</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Value object representing a fallback.</span>

<span class="sd">    A fallback consists of a trigger and an outcome. When the trigger is</span>
<span class="sd">    satisfied, the user flow is rerouted to the given outcome.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">outcome</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span> <span class="o">=</span> <span class="n">outcome</span>

<div class="viewcode-block" id="Fallback.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Fallback.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;trigger&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s">&#39;outcome&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Fallback.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Fallback.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">fallback_dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">TriggerInstance</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fallback_dict</span><span class="p">[</span><span class="s">&#39;trigger&#39;</span><span class="p">]),</span>
            <span class="n">Outcome</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fallback_dict</span><span class="p">[</span><span class="s">&#39;outcome&#39;</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="Fallback.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Fallback.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="InteractionInstance"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.InteractionInstance">[docs]</a><span class="k">class</span> <span class="nc">InteractionInstance</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Value object for an instance of an interaction.&quot;&quot;&quot;</span>

    <span class="c"># The default interaction used for a new state.</span>
    <span class="n">_DEFAULT_INTERACTION_ID</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="InteractionInstance.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.InteractionInstance.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&#39;customization_args&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">{}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span>
                <span class="n">_get_full_customization_args</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span><span class="p">,</span>
                    <span class="n">interaction_registry</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_interaction_by_id</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">customization_arg_specs</span><span class="p">)),</span>
            <span class="s">&#39;answer_groups&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_groups</span><span class="p">],</span>
            <span class="s">&#39;default_outcome&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_outcome</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_outcome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                <span class="k">else</span> <span class="bp">None</span><span class="p">),</span>
            <span class="s">&#39;fallbacks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">fallback</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">fallback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallbacks</span><span class="p">],</span>
        <span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="InteractionInstance.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.InteractionInstance.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">interaction_dict</span><span class="p">):</span>
        <span class="n">default_outcome_dict</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Outcome</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">interaction_dict</span><span class="p">[</span><span class="s">&#39;default_outcome&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">interaction_dict</span><span class="p">[</span><span class="s">&#39;default_outcome&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">interaction_dict</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span>
            <span class="n">interaction_dict</span><span class="p">[</span><span class="s">&#39;customization_args&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="n">AnswerGroup</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">interaction_dict</span><span class="p">[</span><span class="s">&#39;answer_groups&#39;</span><span class="p">]],</span>
            <span class="n">default_outcome_dict</span><span class="p">,</span>
            <span class="p">[</span><span class="n">Fallback</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">interaction_dict</span><span class="p">[</span><span class="s">&#39;fallbacks&#39;</span><span class="p">]])</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">interaction_id</span><span class="p">,</span> <span class="n">customization_args</span><span class="p">,</span> <span class="n">answer_groups</span><span class="p">,</span>
            <span class="n">default_outcome</span><span class="p">,</span> <span class="n">fallbacks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">interaction_id</span>
        <span class="c"># Customization args for the interaction&#39;s view. Parts of these</span>
        <span class="c"># args may be Jinja templates that refer to state parameters.</span>
        <span class="c"># This is a dict: the keys are names of customization_args and the</span>
        <span class="c"># values are dicts with a single key, &#39;value&#39;, whose corresponding</span>
        <span class="c"># value is the value of the customization arg.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span> <span class="o">=</span> <span class="n">customization_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">answer_groups</span> <span class="o">=</span> <span class="n">answer_groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_outcome</span> <span class="o">=</span> <span class="n">default_outcome</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallbacks</span> <span class="o">=</span> <span class="n">fallbacks</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines if this interaction type is terminal. If no ID is set for</span>
<span class="sd">        this interaction, it is assumed to not be terminal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="n">interaction_registry</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_interaction_by_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">is_terminal</span>

<div class="viewcode-block" id="InteractionInstance.get_all_outcomes"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.InteractionInstance.get_all_outcomes">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_outcomes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all outcomes of this interaction, taking into</span>
<span class="sd">        consideration every answer group and the default outcome.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outcomes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">answer_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_groups</span><span class="p">:</span>
            <span class="n">outcomes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer_group</span><span class="o">.</span><span class="n">outcome</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_outcome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">outcomes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_outcome</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outcomes</span>
</div>
<div class="viewcode-block" id="InteractionInstance.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.InteractionInstance.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_param_specs_dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected interaction id to be a string, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">interaction</span> <span class="o">=</span> <span class="n">interaction_registry</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_interaction_by_id</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Invalid interaction id: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">_validate_customization_args_and_values</span><span class="p">(</span>
            <span class="s">&#39;interaction&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">.</span><span class="n">customization_arg_specs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_groups</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected answer groups to be a list, received </span><span class="si">%s</span><span class="s">.&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_groups</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_outcome</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Non-terminal interactions must have a default outcome.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_outcome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Terminal interactions must not have a default outcome.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_groups</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Terminal interactions must not have any answer groups.&#39;</span><span class="p">)</span>

        <span class="n">obj_type</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">interaction_registry</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_interaction_by_id</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">answer_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">answer_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_groups</span><span class="p">:</span>
            <span class="n">answer_group</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">exp_param_specs_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_outcome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_outcome</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fallbacks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected fallbacks to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallbacks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fallback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallbacks</span><span class="p">:</span>
            <span class="n">fallback</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="InteractionInstance.create_default_interaction"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.InteractionInstance.create_default_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">create_default_interaction</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">default_dest_state_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_DEFAULT_INTERACTION_ID</span><span class="p">,</span>
            <span class="p">{},</span> <span class="p">[],</span>
            <span class="n">Outcome</span><span class="p">(</span><span class="n">default_dest_state_name</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{}),</span> <span class="p">[]</span>
        <span class="p">)</span>

</div></div>
<div class="viewcode-block" id="GadgetInstance"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.GadgetInstance">[docs]</a><span class="k">class</span> <span class="nc">GadgetInstance</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Value object for an instance of a gadget.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gadget_id</span><span class="p">,</span> <span class="n">visible_in_states</span><span class="p">,</span> <span class="n">customization_args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">gadget_id</span>

        <span class="c"># List of State name strings where this Gadget is visible.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible_in_states</span> <span class="o">=</span> <span class="n">visible_in_states</span>

        <span class="c"># Customization args for the gadget&#39;s view.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span> <span class="o">=</span> <span class="n">customization_args</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gadget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gadget spec for validation and derived properties below.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">gadget_registry</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_gadget_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Width in pixels.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gadget</span><span class="o">.</span><span class="n">get_width</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Height in pixels.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gadget</span><span class="o">.</span><span class="n">get_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span><span class="p">)</span>

<div class="viewcode-block" id="GadgetInstance.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.GadgetInstance.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate attributes of this GadgetInstance.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gadget</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Unknown gadget with ID </span><span class="si">%s</span><span class="s"> is not in the registry.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">_validate_customization_args_and_values</span><span class="p">(</span>
            <span class="s">&#39;gadget&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gadget</span><span class="o">.</span><span class="n">customization_arg_specs</span><span class="p">)</span>

        <span class="c"># Do additional per-gadget validation on the customization args.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gadget</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_in_states</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s"> gadget not visible in any states.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gadget</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c"># Validate state name visibility isn&#39;t repeated within each gadget.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visible_in_states</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visible_in_states</span><span class="p">)):</span>
            <span class="n">redundant_visible_states</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">state_name</span> <span class="k">for</span> <span class="n">state_name</span><span class="p">,</span> <span class="n">count</span>
                <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visible_in_states</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s"> specifies visibility repeatedly for state</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">redundant_visible_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                    <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">redundant_visible_states</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="GadgetInstance.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.GadgetInstance.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns GadgetInstance data represented in dict form.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;gadget_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&#39;visible_in_states&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_in_states</span><span class="p">,</span>
            <span class="s">&#39;customization_args&#39;</span><span class="p">:</span> <span class="n">_get_full_customization_args</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">customization_args</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gadget</span><span class="o">.</span><span class="n">customization_arg_specs</span><span class="p">),</span>
        <span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="GadgetInstance.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.GadgetInstance.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">gadget_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns GadgetInstance constructed from dict data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GadgetInstance</span><span class="p">(</span>
            <span class="n">gadget_dict</span><span class="p">[</span><span class="s">&#39;gadget_id&#39;</span><span class="p">],</span>
            <span class="n">gadget_dict</span><span class="p">[</span><span class="s">&#39;visible_in_states&#39;</span><span class="p">],</span>
            <span class="n">gadget_dict</span><span class="p">[</span><span class="s">&#39;customization_args&#39;</span><span class="p">])</span>

</div></div>
<div class="viewcode-block" id="SkinInstance"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.SkinInstance">[docs]</a><span class="k">class</span> <span class="nc">SkinInstance</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Domain object for a skin instance.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skin_id</span><span class="p">,</span> <span class="n">skin_customizations</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skin_id</span> <span class="o">=</span> <span class="n">skin_id</span>
        <span class="c"># panel_contents_dict has gadget_panel_name strings as keys and</span>
        <span class="c"># lists of GadgetInstance instances as values.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">panel_contents_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">panel_name</span><span class="p">,</span> <span class="n">gdict_list</span> <span class="ow">in</span> <span class="n">skin_customizations</span><span class="p">[</span>
                <span class="s">&#39;panels_contents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">panel_contents_dict</span><span class="p">[</span><span class="n">panel_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">GadgetInstance</span><span class="p">(</span>
                <span class="n">gdict</span><span class="p">[</span><span class="s">&#39;gadget_id&#39;</span><span class="p">],</span> <span class="n">gdict</span><span class="p">[</span><span class="s">&#39;visible_in_states&#39;</span><span class="p">],</span>
                <span class="n">gdict</span><span class="p">[</span><span class="s">&#39;customization_args&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">gdict</span> <span class="ow">in</span> <span class="n">gdict_list</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">skin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Skin spec for validation and derived properties.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">skins_services</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_skin_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skin_id</span><span class="p">)</span>

<div class="viewcode-block" id="SkinInstance.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.SkinInstance.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates that gadgets fit the skin panel dimensions, and that the</span>
<span class="sd">        gadgets themselves are valid.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">panel_name</span><span class="p">,</span> <span class="n">gadget_instances_list</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">panel_contents_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()):</span>

            <span class="c"># Validate existence of panels in the skin.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">panel_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skin</span><span class="o">.</span><span class="n">panels_properties</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;</span><span class="si">%s</span><span class="s"> panel not found in skin </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">panel_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skin_id</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c"># Validate gadgets fit each skin panel.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skin</span><span class="o">.</span><span class="n">validate_panel</span><span class="p">(</span><span class="n">panel_name</span><span class="p">,</span> <span class="n">gadget_instances_list</span><span class="p">)</span>

            <span class="c"># Validate gadget internal attributes.</span>
            <span class="k">for</span> <span class="n">gadget_instance</span> <span class="ow">in</span> <span class="n">gadget_instances_list</span><span class="p">:</span>
                <span class="n">gadget_instance</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SkinInstance.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.SkinInstance.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns SkinInstance data represented in dict form.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;skin_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">skin_id</span><span class="p">,</span>
            <span class="s">&#39;skin_customizations&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;panels_contents&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">panel_name</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">gadget_instance</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">gadget_instance</span>
                        <span class="ow">in</span> <span class="n">instances_list</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">panel_name</span><span class="p">,</span> <span class="n">instances_list</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">panel_contents_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="SkinInstance.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.SkinInstance.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">skin_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns SkinInstance instance given dict form.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SkinInstance</span><span class="p">(</span>
            <span class="n">skin_dict</span><span class="p">[</span><span class="s">&#39;skin_id&#39;</span><span class="p">],</span>
            <span class="n">skin_dict</span><span class="p">[</span><span class="s">&#39;skin_customizations&#39;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="SkinInstance.get_state_names_required_by_gadgets"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.SkinInstance.get_state_names_required_by_gadgets">[docs]</a>    <span class="k">def</span> <span class="nf">get_state_names_required_by_gadgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of strings representing State names required by</span>
<span class="sd">        GadgetInstances in this skin.&quot;&quot;&quot;</span>
        <span class="n">state_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">gadget_instances_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">panel_contents_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">gadget_instance</span> <span class="ow">in</span> <span class="n">gadget_instances_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">state_name</span> <span class="ow">in</span> <span class="n">gadget_instance</span><span class="o">.</span><span class="n">visible_in_states</span><span class="p">:</span>
                    <span class="n">state_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span>

        <span class="c"># We convert to a sorted list for clean deterministic testing.</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">state_names</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="State"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State">[docs]</a><span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Domain object for a state.&quot;&quot;&quot;</span>

    <span class="n">NULL_INTERACTION_DICT</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;customization_args&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s">&#39;answer_groups&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s">&#39;default_outcome&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;dest&#39;</span><span class="p">:</span> <span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_INIT_STATE_NAME</span><span class="p">,</span>
            <span class="s">&#39;feedback&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;param_changes&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">},</span>
        <span class="s">&#39;fallbacks&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">param_changes</span><span class="p">,</span> <span class="n">interaction</span><span class="p">):</span>
        <span class="c"># The content displayed to the reader in this state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">Content</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">content</span><span class="p">]</span>
        <span class="c"># Parameter changes associated with this state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_domain</span><span class="o">.</span><span class="n">ParamChange</span><span class="p">(</span>
            <span class="n">param_change</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">param_change</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">param_change</span><span class="o">.</span><span class="n">customization_args</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="n">param_changes</span><span class="p">]</span>
        <span class="c"># The interaction instance associated with this state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">InteractionInstance</span><span class="p">(</span>
            <span class="n">interaction</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">interaction</span><span class="o">.</span><span class="n">customization_args</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">.</span><span class="n">answer_groups</span><span class="p">,</span> <span class="n">interaction</span><span class="o">.</span><span class="n">default_outcome</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">.</span><span class="n">fallbacks</span><span class="p">)</span>

<div class="viewcode-block" id="State.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_param_specs_dict</span><span class="p">,</span> <span class="n">allow_null_interaction</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected state content to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;The state content list must have exactly one element. &#39;</span>
                <span class="s">&#39;Received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected state param_changes to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">:</span>
            <span class="n">param_change</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_null_interaction</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;This state does not have any interaction specified.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">exp_param_specs_dict</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="State.update_content"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.update_content">[docs]</a>    <span class="k">def</span> <span class="nf">update_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_list</span><span class="p">):</span>
        <span class="c"># TODO(sll): Must sanitize all content in RTE component attrs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">Content</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">content_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
</div>
<div class="viewcode-block" id="State.update_param_changes"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.update_param_changes">[docs]</a>    <span class="k">def</span> <span class="nf">update_param_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_change_dicts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param_domain</span><span class="o">.</span><span class="n">ParamChange</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">param_change_dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param_change_dict</span> <span class="ow">in</span> <span class="n">param_change_dicts</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="State.update_interaction_id"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.update_interaction_id">[docs]</a>    <span class="k">def</span> <span class="nf">update_interaction_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interaction_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">interaction_id</span>
        <span class="c"># TODO(sll): This should also clear interaction.answer_groups (except</span>
        <span class="c"># for the default rule). This is somewhat mitigated because the client</span>
        <span class="c"># updates interaction_answer_groups directly after this, but we should</span>
        <span class="c"># fix it.</span>
</div>
<div class="viewcode-block" id="State.update_interaction_customization_args"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.update_interaction_customization_args">[docs]</a>    <span class="k">def</span> <span class="nf">update_interaction_customization_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customization_args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">customization_args</span> <span class="o">=</span> <span class="n">customization_args</span>
</div>
<div class="viewcode-block" id="State.update_interaction_answer_groups"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.update_interaction_answer_groups">[docs]</a>    <span class="k">def</span> <span class="nf">update_interaction_answer_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer_groups_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">answer_groups_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&#39;Expected interaction_answer_groups to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="n">answer_groups_list</span><span class="p">)</span>

        <span class="n">interaction_answer_groups</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># TODO(yanamal): Do additional calculations here to get the</span>
        <span class="c"># parameter changes, if necessary.</span>
        <span class="k">for</span> <span class="n">answer_group_dict</span> <span class="ow">in</span> <span class="n">answer_groups_list</span><span class="p">:</span>
            <span class="n">rule_specs_list</span> <span class="o">=</span> <span class="n">answer_group_dict</span><span class="p">[</span><span class="s">&#39;rule_specs&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule_specs_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&#39;Expected answer group rule specs to be a list, &#39;</span>
                    <span class="s">&#39;received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">rule_specs_list</span><span class="p">)</span>

            <span class="n">answer_group</span> <span class="o">=</span> <span class="n">AnswerGroup</span><span class="p">(</span><span class="n">Outcome</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="n">answer_group_dict</span><span class="p">[</span><span class="s">&#39;outcome&#39;</span><span class="p">]),</span> <span class="p">[])</span>
            <span class="n">answer_group</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">feedback</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">html_cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">feedback</span> <span class="ow">in</span> <span class="n">answer_group</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">feedback</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">rule_dict</span> <span class="ow">in</span> <span class="n">rule_specs_list</span><span class="p">:</span>
                <span class="n">rule_spec</span> <span class="o">=</span> <span class="n">RuleSpec</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">rule_dict</span><span class="p">)</span>

                <span class="n">matched_rule</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">interaction_registry</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_interaction_by_id</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">id</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">get_rule_by_name</span><span class="p">(</span><span class="n">rule_spec</span><span class="o">.</span><span class="n">rule_type</span><span class="p">))</span>

                <span class="c"># Normalize and store the rule params.</span>
                <span class="n">rule_inputs</span> <span class="o">=</span> <span class="n">rule_spec</span><span class="o">.</span><span class="n">inputs</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule_inputs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s">&#39;Expected rule_inputs to be a dict, received </span><span class="si">%s</span><span class="s">&#39;</span>
                        <span class="o">%</span> <span class="n">rule_inputs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rule_inputs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="n">param_type</span> <span class="o">=</span> <span class="n">rule_domain</span><span class="o">.</span><span class="n">get_obj_type_for_param_name</span><span class="p">(</span>
                        <span class="n">matched_rule</span><span class="p">,</span> <span class="n">param_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="s">&#39;{{&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">and</span> <span class="s">&#39;}}&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
                        <span class="c"># TODO(jacobdavis11): Create checks that all parameters</span>
                        <span class="c"># referred to exist and have the correct types</span>
                        <span class="n">normalized_param</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">normalized_param</span> <span class="o">=</span> <span class="n">param_type</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                                <span class="s">&#39;</span><span class="si">%s</span><span class="s"> has the wrong type. It should be a </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">param_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
                    <span class="n">rule_inputs</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_param</span>

                <span class="n">answer_group</span><span class="o">.</span><span class="n">rule_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule_spec</span><span class="p">)</span>
            <span class="n">interaction_answer_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer_group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">answer_groups</span> <span class="o">=</span> <span class="n">interaction_answer_groups</span>
</div>
<div class="viewcode-block" id="State.update_interaction_default_outcome"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.update_interaction_default_outcome">[docs]</a>    <span class="k">def</span> <span class="nf">update_interaction_default_outcome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_outcome_dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">default_outcome_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_outcome_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s">&#39;Expected default_outcome_dict to be a dict, received </span><span class="si">%s</span><span class="s">&#39;</span>
                    <span class="o">%</span> <span class="n">default_outcome_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">default_outcome</span> <span class="o">=</span> <span class="n">Outcome</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="n">default_outcome_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">default_outcome</span><span class="o">.</span><span class="n">feedback</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">html_cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">feedback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">default_outcome</span><span class="o">.</span><span class="n">feedback</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">default_outcome</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="State.update_interaction_fallbacks"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.update_interaction_fallbacks">[docs]</a>    <span class="k">def</span> <span class="nf">update_interaction_fallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fallbacks_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fallbacks_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&#39;Expected fallbacks_list to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="n">fallbacks_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">fallbacks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Fallback</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fallback_dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fallback_dict</span> <span class="ow">in</span> <span class="n">fallbacks_list</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="State.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">],</span>
            <span class="s">&#39;param_changes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">param_change</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                              <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">],</span>
            <span class="s">&#39;interaction&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="State.from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Content</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">param_domain</span><span class="o">.</span><span class="n">ParamChange</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">[</span><span class="s">&#39;param_changes&#39;</span><span class="p">]],</span>
            <span class="n">InteractionInstance</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">]))</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="State.create_default_state"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.State.create_default_state">[docs]</a>    <span class="k">def</span> <span class="nf">create_default_state</span><span class="p">(</span>
            <span class="n">cls</span><span class="p">,</span> <span class="n">default_dest_state_name</span><span class="p">,</span> <span class="n">is_initial_state</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">text_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_INIT_STATE_CONTENT_STR</span> <span class="k">if</span> <span class="n">is_initial_state</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Content</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="n">text_str</span><span class="p">)],</span> <span class="p">[],</span>
            <span class="n">InteractionInstance</span><span class="o">.</span><span class="n">create_default_interaction</span><span class="p">(</span>
                <span class="n">default_dest_state_name</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="Exploration"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration">[docs]</a><span class="k">class</span> <span class="nc">Exploration</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Domain object for an Oppia exploration.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exploration_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span>
                 <span class="n">language_code</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">blurb</span><span class="p">,</span> <span class="n">author_notes</span><span class="p">,</span> <span class="n">default_skin</span><span class="p">,</span>
                 <span class="n">skin_customizations</span><span class="p">,</span> <span class="n">states_schema_version</span><span class="p">,</span> <span class="n">init_state_name</span><span class="p">,</span>
                 <span class="n">states_dict</span><span class="p">,</span> <span class="n">param_specs_dict</span><span class="p">,</span> <span class="n">param_changes_list</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span>
                 <span class="n">created_on</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">last_updated</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">exploration_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language_code</span> <span class="o">=</span> <span class="n">language_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blurb</span> <span class="o">=</span> <span class="n">blurb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author_notes</span> <span class="o">=</span> <span class="n">author_notes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_skin</span> <span class="o">=</span> <span class="n">default_skin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states_schema_version</span> <span class="o">=</span> <span class="n">states_schema_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span> <span class="o">=</span> <span class="n">init_state_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">skin_instance</span> <span class="o">=</span> <span class="n">SkinInstance</span><span class="p">(</span><span class="n">default_skin</span><span class="p">,</span> <span class="n">skin_customizations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">)</span> <span class="ow">in</span> <span class="n">states_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">state_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ps_name</span><span class="p">:</span> <span class="n">param_domain</span><span class="o">.</span><span class="n">ParamSpec</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">ps_val</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ps_name</span><span class="p">,</span> <span class="n">ps_val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">param_specs_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param_domain</span><span class="o">.</span><span class="n">ParamChange</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">param_change_dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param_change_dict</span> <span class="ow">in</span> <span class="n">param_changes_list</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_on</span> <span class="o">=</span> <span class="n">created_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">last_updated</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Exploration.create_default_exploration"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.create_default_exploration">[docs]</a>    <span class="k">def</span> <span class="nf">create_default_exploration</span><span class="p">(</span>
            <span class="n">cls</span><span class="p">,</span> <span class="n">exploration_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="n">language_code</span><span class="o">=</span><span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_LANGUAGE_CODE</span><span class="p">):</span>
        <span class="n">init_state_dict</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="n">create_default_state</span><span class="p">(</span>
            <span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_INIT_STATE_NAME</span><span class="p">,</span> <span class="n">is_initial_state</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">states_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_INIT_STATE_NAME</span><span class="p">:</span> <span class="n">init_state_dict</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">exploration_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">language_code</span><span class="p">,</span> <span class="p">[],</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;conversation_v1&#39;</span><span class="p">,</span> <span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_SKIN_CUSTOMIZATIONS</span><span class="p">,</span>
            <span class="n">feconf</span><span class="o">.</span><span class="n">CURRENT_EXPLORATION_STATES_SCHEMA_VERSION</span><span class="p">,</span>
            <span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_INIT_STATE_NAME</span><span class="p">,</span> <span class="n">states_dict</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Exploration.create_exploration_from_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.create_exploration_from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">create_exploration_from_dict</span><span class="p">(</span>
            <span class="n">cls</span><span class="p">,</span> <span class="n">exploration_dict</span><span class="p">,</span>
            <span class="n">exploration_version</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">exploration_created_on</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">exploration_last_updated</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># NOTE TO DEVELOPERS: It is absolutely ESSENTIAL this conversion to and</span>
        <span class="c"># from an ExplorationModel/dictionary MUST be exhaustive and complete.</span>
        <span class="n">exploration</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">create_default_exploration</span><span class="p">(</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">],</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">],</span>
            <span class="n">objective</span><span class="o">=</span><span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;objective&#39;</span><span class="p">],</span>
            <span class="n">language_code</span><span class="o">=</span><span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;language_code&#39;</span><span class="p">])</span>
        <span class="n">exploration</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]</span>
        <span class="n">exploration</span><span class="o">.</span><span class="n">blurb</span> <span class="o">=</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;blurb&#39;</span><span class="p">]</span>
        <span class="n">exploration</span><span class="o">.</span><span class="n">author_notes</span> <span class="o">=</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;author_notes&#39;</span><span class="p">]</span>

        <span class="n">exploration</span><span class="o">.</span><span class="n">param_specs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ps_name</span><span class="p">:</span> <span class="n">param_domain</span><span class="o">.</span><span class="n">ParamSpec</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">ps_val</span><span class="p">)</span> <span class="k">for</span>
            <span class="p">(</span><span class="n">ps_name</span><span class="p">,</span> <span class="n">ps_val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;param_specs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">exploration</span><span class="o">.</span><span class="n">states_schema_version</span> <span class="o">=</span> <span class="n">exploration_dict</span><span class="p">[</span>
            <span class="s">&#39;states_schema_version&#39;</span><span class="p">]</span>
        <span class="n">init_state_name</span> <span class="o">=</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;init_state_name&#39;</span><span class="p">]</span>
        <span class="n">exploration</span><span class="o">.</span><span class="n">rename_state</span><span class="p">(</span><span class="n">exploration</span><span class="o">.</span><span class="n">init_state_name</span><span class="p">,</span> <span class="n">init_state_name</span><span class="p">)</span>
        <span class="n">exploration</span><span class="o">.</span><span class="n">add_states</span><span class="p">([</span>
            <span class="n">state_name</span> <span class="k">for</span> <span class="n">state_name</span> <span class="ow">in</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">state_name</span> <span class="o">!=</span> <span class="n">init_state_name</span><span class="p">])</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">sdict</span><span class="p">)</span> <span class="ow">in</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">exploration</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">state_name</span><span class="p">]</span>

            <span class="n">state</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Content</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">],</span> <span class="n">html_cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sdict</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span>
            <span class="p">]</span>

            <span class="n">state</span><span class="o">.</span><span class="n">param_changes</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_domain</span><span class="o">.</span><span class="n">ParamChange</span><span class="p">(</span>
                <span class="n">pc</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="s">&#39;generator_id&#39;</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="s">&#39;customization_args&#39;</span><span class="p">]</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">sdict</span><span class="p">[</span><span class="s">&#39;param_changes&#39;</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">param_changes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pc</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exploration</span><span class="o">.</span><span class="n">param_specs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Parameter </span><span class="si">%s</span><span class="s"> was used in a state but not &#39;</span>
                                    <span class="s">&#39;declared in the exploration param_specs.&#39;</span>
                                    <span class="o">%</span> <span class="n">pc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">idict</span> <span class="o">=</span> <span class="n">sdict</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">]</span>
            <span class="n">interaction_answer_groups</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">AnswerGroup</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
                    <span class="s">&#39;outcome&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">&#39;dest&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s">&#39;outcome&#39;</span><span class="p">][</span><span class="s">&#39;dest&#39;</span><span class="p">],</span>
                        <span class="s">&#39;feedback&#39;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">html_cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">feedback</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s">&#39;outcome&#39;</span><span class="p">][</span><span class="s">&#39;feedback&#39;</span><span class="p">]],</span>
                        <span class="s">&#39;param_changes&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s">&#39;outcome&#39;</span><span class="p">][</span><span class="s">&#39;param_changes&#39;</span><span class="p">],</span>
                    <span class="p">},</span>
                    <span class="s">&#39;rule_specs&#39;</span><span class="p">:</span> <span class="p">[{</span>
                        <span class="s">&#39;inputs&#39;</span><span class="p">:</span> <span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;inputs&#39;</span><span class="p">],</span>
                        <span class="s">&#39;rule_type&#39;</span><span class="p">:</span> <span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;rule_type&#39;</span><span class="p">],</span>
                    <span class="p">}</span> <span class="k">for</span> <span class="n">rule_spec</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s">&#39;rule_specs&#39;</span><span class="p">]],</span>
                <span class="p">})</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">idict</span><span class="p">[</span><span class="s">&#39;answer_groups&#39;</span><span class="p">]]</span>

            <span class="n">default_outcome</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Outcome</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">idict</span><span class="p">[</span><span class="s">&#39;default_outcome&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">idict</span><span class="p">[</span><span class="s">&#39;default_outcome&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>

            <span class="n">state</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="n">InteractionInstance</span><span class="p">(</span>
                <span class="n">idict</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">idict</span><span class="p">[</span><span class="s">&#39;customization_args&#39;</span><span class="p">],</span>
                <span class="n">interaction_answer_groups</span><span class="p">,</span> <span class="n">default_outcome</span><span class="p">,</span>
                <span class="p">[</span><span class="n">Fallback</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">idict</span><span class="p">[</span><span class="s">&#39;fallbacks&#39;</span><span class="p">]])</span>

            <span class="n">exploration</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">state_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

        <span class="n">exploration</span><span class="o">.</span><span class="n">default_skin</span> <span class="o">=</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;default_skin&#39;</span><span class="p">]</span>
        <span class="n">exploration</span><span class="o">.</span><span class="n">param_changes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param_domain</span><span class="o">.</span><span class="n">ParamChange</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;param_changes&#39;</span><span class="p">]]</span>

        <span class="n">exploration</span><span class="o">.</span><span class="n">skin_instance</span> <span class="o">=</span> <span class="n">SkinInstance</span><span class="p">(</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;default_skin&#39;</span><span class="p">],</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;skin_customizations&#39;</span><span class="p">])</span>

        <span class="n">exploration</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">exploration_version</span>
        <span class="n">exploration</span><span class="o">.</span><span class="n">created_on</span> <span class="o">=</span> <span class="n">exploration_created_on</span>
        <span class="n">exploration</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">exploration_last_updated</span>

        <span class="k">return</span> <span class="n">exploration</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_require_valid_name</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic name validation.</span>

<span class="sd">        Args:</span>
<span class="sd">          name: the name to validate.</span>
<span class="sd">          name_type: a human-readable string, like &#39;the exploration title&#39; or</span>
<span class="sd">            &#39;a state name&#39;. This will be shown in error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># This check is needed because state names are used in URLs and as ids</span>
        <span class="c"># for statistics, so the name length should be bounded above.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;The length of </span><span class="si">%s</span><span class="s"> should be between 1 and 50 &#39;</span>
                <span class="s">&#39;characters; received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name_type</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">whitespace</span> <span class="ow">or</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Names should not start or end with whitespace.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\s\s+&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Adjacent whitespace in </span><span class="si">%s</span><span class="s"> should be collapsed.&#39;</span> <span class="o">%</span> <span class="n">name_type</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feconf</span><span class="o">.</span><span class="n">INVALID_NAME_CHARS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Invalid character </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name_type</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_require_valid_state_name</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_require_valid_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;a state name&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Exploration.validate"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates the exploration before it is committed to storage.</span>

<span class="sd">        If strict is True, performs advanced validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected title to be a string, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_require_valid_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&#39;the exploration title&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected category to be a string, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_require_valid_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="s">&#39;the exploration category&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected objective to be a string, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">language_code</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected language_code to be a string, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">language_code</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">language_code</span> <span class="o">==</span> <span class="n">lc</span><span class="p">[</span><span class="s">&#39;code&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">feconf</span><span class="o">.</span><span class="n">ALL_LANGUAGE_CODES</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Invalid language_code: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_code</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected </span><span class="se">\&#39;</span><span class="s">tags</span><span class="se">\&#39;</span><span class="s"> to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Expected each tag in </span><span class="se">\&#39;</span><span class="s">tags</span><span class="se">\&#39;</span><span class="s"> to be a string, received &#39;</span>
                    <span class="s">&#39;</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Tags should be non-empty.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">feconf</span><span class="o">.</span><span class="n">TAG_REGEX</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Tags should only contain lowercase letters and spaces, &#39;</span>
                    <span class="s">&#39;received </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="ow">or</span>
                    <span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Tags should not start or end with whitespace, received &#39;</span>
                    <span class="s">&#39; </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\s\s+&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Adjacent whitespace in tags should be collapsed, &#39;</span>
                    <span class="s">&#39;received </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Some tags duplicate each other&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blurb</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected blurb to be a string, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">blurb</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author_notes</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected author_notes to be a string, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">author_notes</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_skin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected a default_skin to be specified.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_skin</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected default_skin to be a string, received </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">).&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_skin</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_skin</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_skin</span> <span class="ow">in</span> <span class="n">skins_services</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_all_skin_ids</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Unrecognized skin id: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_skin</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected states to be a dict, received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;This exploration has no states.&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_require_valid_state_name</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">state_name</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span><span class="p">,</span>
                <span class="n">allow_null_interaction</span><span class="o">=</span><span class="ow">not</span> <span class="n">strict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">states_schema_version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;This exploration has no states schema version.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;This exploration has no initial state name specified.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;There is no state in </span><span class="si">%s</span><span class="s"> corresponding to the exploration</span><span class="se">\&#39;</span><span class="s">s &#39;</span>
                <span class="s">&#39;initial state name </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected param_specs to be a dict, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Expected parameter name to be a string, received </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">).&#39;</span>
                    <span class="o">%</span> <span class="n">param_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">feconf</span><span class="o">.</span><span class="n">ALPHANUMERIC_REGEX</span><span class="p">,</span> <span class="n">param_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Only parameter names with characters in [a-zA-Z0-9] are &#39;</span>
                    <span class="s">&#39;accepted.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Expected param_changes to be a list, received </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">:</span>
            <span class="n">param_change</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">param_change</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;No parameter named </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> exists in this exploration&#39;</span>
                    <span class="o">%</span> <span class="n">param_change</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param_change</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">feconf</span><span class="o">.</span><span class="n">INVALID_PARAMETER_NAMES</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;The exploration-level parameter with name </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is &#39;</span>
                    <span class="s">&#39;reserved. Please choose a different name.&#39;</span>
                    <span class="o">%</span> <span class="n">param_change</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c"># TODO(sll): Find a way to verify the param change customization args</span>
        <span class="c"># when they depend on exploration/state parameters (e.g. the generated</span>
        <span class="c"># values must have the correct obj_type). Can we get sample values for</span>
        <span class="c"># the reader&#39;s answer and these parameters by looking at states that</span>
        <span class="c"># link to this one?</span>

        <span class="c"># Check that all state param changes are valid.</span>
        <span class="k">for</span> <span class="n">state_name</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">param_changes</span><span class="p">:</span>
                <span class="n">param_change</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">param_change</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                        <span class="s">&#39;The parameter with name </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> was set in state &#39;</span>
                        <span class="s">&#39;</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">, but it does not exist in the list of &#39;</span>
                        <span class="s">&#39;parameter specifications for this exploration.&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">param_change</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">param_change</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">feconf</span><span class="o">.</span><span class="n">INVALID_PARAMETER_NAMES</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                        <span class="s">&#39;The parameter name </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is reserved. Please choose &#39;</span>
                        <span class="s">&#39;a different name for the parameter being set in &#39;</span>
                        <span class="s">&#39;state </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param_change</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state_name</span><span class="p">))</span>

        <span class="c"># Check that all answer groups, outcomes, and param_changes are valid.</span>
        <span class="n">all_state_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">interaction</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">interaction</span>

            <span class="c"># Check the default destination, if any</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">interaction</span><span class="o">.</span><span class="n">default_outcome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">interaction</span><span class="o">.</span><span class="n">default_outcome</span><span class="o">.</span><span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_state_names</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;The destination </span><span class="si">%s</span><span class="s"> is not a valid state.&#39;</span>
                    <span class="o">%</span> <span class="n">interaction</span><span class="o">.</span><span class="n">default_outcome</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">interaction</span><span class="o">.</span><span class="n">answer_groups</span><span class="p">:</span>
                <span class="c"># Check group destinations.</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_state_names</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                        <span class="s">&#39;The destination </span><span class="si">%s</span><span class="s"> is not a valid state.&#39;</span>
                        <span class="o">%</span> <span class="n">group</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">param_changes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">param_change</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                            <span class="s">&#39;The parameter </span><span class="si">%s</span><span class="s"> was used in a rule, but it &#39;</span>
                            <span class="s">&#39;does not exist in this exploration&#39;</span>
                            <span class="o">%</span> <span class="n">param_change</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c"># Check that state names required by gadgets exist.</span>
        <span class="n">state_names_required_by_gadgets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skin_instance</span><span class="o">.</span><span class="n">get_state_names_required_by_gadgets</span><span class="p">())</span>
        <span class="n">missing_state_names</span> <span class="o">=</span> <span class="n">state_names_required_by_gadgets</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">missing_state_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Exploration missing required state</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="s">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_state_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                    <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">missing_state_names</span><span class="p">)))</span>
                <span class="p">)</span>

        <span class="c"># Check that GadgetInstances fit the skin and that gadgets are valid.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skin_instance</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
            <span class="n">warnings_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verify_all_states_reachable</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verify_no_dead_ends</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">:</span>
                <span class="n">warnings_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s">&#39;An objective must be specified (in the </span><span class="se">\&#39;</span><span class="s">Settings</span><span class="se">\&#39;</span><span class="s"> tab).&#39;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_code</span><span class="p">:</span>
                <span class="n">warnings_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s">&#39;A language must be specified (in the </span><span class="se">\&#39;</span><span class="s">Settings</span><span class="se">\&#39;</span><span class="s"> tab).&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warning_str</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">warning</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">warnings_list</span><span class="p">):</span>
                    <span class="n">warning_str</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">. </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">warning</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s">&#39;Please fix the following issues before saving this &#39;</span>
                    <span class="s">&#39;exploration: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">warning_str</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_verify_all_states_reachable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verifies that all states are reachable from the initial state.&quot;&quot;&quot;</span>
        <span class="c"># This queue stores state names.</span>
        <span class="n">processed_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curr_queue</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">curr_queue</span><span class="p">:</span>
            <span class="n">curr_state_name</span> <span class="o">=</span> <span class="n">curr_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">curr_queue</span> <span class="o">=</span> <span class="n">curr_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">curr_state_name</span> <span class="ow">in</span> <span class="n">processed_queue</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">processed_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_state_name</span><span class="p">)</span>

            <span class="n">curr_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">curr_state_name</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">curr_state</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">:</span>
                <span class="n">all_outcomes</span> <span class="o">=</span> <span class="n">curr_state</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">get_all_outcomes</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">all_outcomes</span><span class="p">:</span>
                    <span class="n">dest_state</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">dest</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">dest_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">curr_queue</span> <span class="ow">and</span>
                            <span class="n">dest_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processed_queue</span><span class="p">):</span>
                        <span class="n">curr_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest_state</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_queue</span><span class="p">):</span>
            <span class="n">unseen_states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">processed_queue</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;The following states are not reachable from the initial &#39;</span>
                <span class="s">&#39;state: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unseen_states</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_verify_no_dead_ends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verifies that all states can reach a terminal state.&quot;&quot;&quot;</span>
        <span class="c"># This queue stores state names.</span>
        <span class="n">processed_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curr_queue</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">:</span>
                <span class="n">curr_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">curr_queue</span><span class="p">:</span>
            <span class="n">curr_state_name</span> <span class="o">=</span> <span class="n">curr_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">curr_queue</span> <span class="o">=</span> <span class="n">curr_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">curr_state_name</span> <span class="ow">in</span> <span class="n">processed_queue</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">processed_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_state_name</span><span class="p">)</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">state_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">curr_queue</span>
                        <span class="ow">and</span> <span class="n">state_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processed_queue</span><span class="p">):</span>
                    <span class="n">all_outcomes</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">get_all_outcomes</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">all_outcomes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">dest</span> <span class="o">==</span> <span class="n">curr_state_name</span><span class="p">:</span>
                            <span class="n">curr_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span>
                            <span class="k">break</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_queue</span><span class="p">):</span>
            <span class="n">dead_end_states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">processed_queue</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;It is impossible to complete the exploration from the &#39;</span>
                <span class="s">&#39;following states: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dead_end_states</span><span class="p">))</span>

    <span class="c"># Derived attributes of an exploration,</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">init_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The state which forms the start of this exploration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_specs_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A dict of param specs, each represented as Python dicts.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">ps_name</span><span class="p">:</span> <span class="n">ps_val</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ps_name</span><span class="p">,</span> <span class="n">ps_val</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_change_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of param changes, represented as JSONifiable Python dicts.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">param_change</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Exploration.is_demo_exploration_id"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.is_demo_exploration_id">[docs]</a>    <span class="k">def</span> <span class="nf">is_demo_exploration_id</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exploration_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whether the exploration id is that of a demo exploration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">exploration_id</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">exploration_id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">feconf</span><span class="o">.</span><span class="n">DEMO_EXPLORATIONS</span><span class="p">))</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_demo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whether the exploration is one of the demo explorations.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_demo_exploration_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<div class="viewcode-block" id="Exploration.update_title"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_title">[docs]</a>    <span class="k">def</span> <span class="nf">update_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
</div>
<div class="viewcode-block" id="Exploration.update_category"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_category">[docs]</a>    <span class="k">def</span> <span class="nf">update_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span>
</div>
<div class="viewcode-block" id="Exploration.update_objective"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_objective">[docs]</a>    <span class="k">def</span> <span class="nf">update_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span>
</div>
<div class="viewcode-block" id="Exploration.update_language_code"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_language_code">[docs]</a>    <span class="k">def</span> <span class="nf">update_language_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language_code</span> <span class="o">=</span> <span class="n">language_code</span>
</div>
<div class="viewcode-block" id="Exploration.update_tags"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_tags">[docs]</a>    <span class="k">def</span> <span class="nf">update_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>
</div>
<div class="viewcode-block" id="Exploration.update_blurb"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_blurb">[docs]</a>    <span class="k">def</span> <span class="nf">update_blurb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blurb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blurb</span> <span class="o">=</span> <span class="n">blurb</span>
</div>
<div class="viewcode-block" id="Exploration.update_author_notes"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_author_notes">[docs]</a>    <span class="k">def</span> <span class="nf">update_author_notes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">author_notes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author_notes</span> <span class="o">=</span> <span class="n">author_notes</span>
</div>
<div class="viewcode-block" id="Exploration.update_param_specs"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_param_specs">[docs]</a>    <span class="k">def</span> <span class="nf">update_param_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_specs_dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_specs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ps_name</span><span class="p">:</span> <span class="n">param_domain</span><span class="o">.</span><span class="n">ParamSpec</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">ps_val</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ps_name</span><span class="p">,</span> <span class="n">ps_val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">param_specs_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
        <span class="p">}</span>
</div>
<div class="viewcode-block" id="Exploration.update_param_changes"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_param_changes">[docs]</a>    <span class="k">def</span> <span class="nf">update_param_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_changes_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_changes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">param_domain</span><span class="o">.</span><span class="n">ParamChange</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">param_change</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param_change</span> <span class="ow">in</span> <span class="n">param_changes_list</span>
        <span class="p">]</span>
</div>
<div class="viewcode-block" id="Exploration.update_default_skin_id"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_default_skin_id">[docs]</a>    <span class="k">def</span> <span class="nf">update_default_skin_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_skin_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_skin</span> <span class="o">=</span> <span class="n">default_skin_id</span>
</div>
<div class="viewcode-block" id="Exploration.update_init_state_name"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_init_state_name">[docs]</a>    <span class="k">def</span> <span class="nf">update_init_state_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_state_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">init_state_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&#39;Invalid new initial state name: </span><span class="si">%s</span><span class="s">; &#39;</span>
                <span class="s">&#39;it is not in the list of states </span><span class="si">%s</span><span class="s"> for this &#39;</span>
                <span class="s">&#39;exploration.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">init_state_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span> <span class="o">=</span> <span class="n">init_state_name</span>

    <span class="c"># Methods relating to states.</span></div>
<div class="viewcode-block" id="Exploration.add_states"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.add_states">[docs]</a>    <span class="k">def</span> <span class="nf">add_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds multiple states to the exploration.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">state_name</span> <span class="ow">in</span> <span class="n">state_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Duplicate state name </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">state_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">state_name</span> <span class="ow">in</span> <span class="n">state_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">state_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="n">create_default_state</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Exploration.rename_state"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.rename_state">[docs]</a>    <span class="k">def</span> <span class="nf">rename_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_state_name</span><span class="p">,</span> <span class="n">new_state_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renames the given state.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">old_state_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;State </span><span class="si">%s</span><span class="s"> does not exist&#39;</span> <span class="o">%</span> <span class="n">old_state_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">old_state_name</span> <span class="o">!=</span> <span class="n">new_state_name</span> <span class="ow">and</span>
                <span class="n">new_state_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Duplicate state name: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">new_state_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">old_state_name</span> <span class="o">==</span> <span class="n">new_state_name</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_require_valid_state_name</span><span class="p">(</span><span class="n">new_state_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">new_state_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">old_state_name</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">old_state_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span> <span class="o">==</span> <span class="n">old_state_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_init_state_name</span><span class="p">(</span><span class="n">new_state_name</span><span class="p">)</span>

        <span class="c"># Find all destinations in the exploration which equal the renamed</span>
        <span class="c"># state, and change the name appropriately.</span>
        <span class="k">for</span> <span class="n">other_state_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="n">other_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">other_state_name</span><span class="p">]</span>
            <span class="n">other_outcomes</span> <span class="o">=</span> <span class="n">other_state</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">get_all_outcomes</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">other_outcomes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">dest</span> <span class="o">==</span> <span class="n">old_state_name</span><span class="p">:</span>
                    <span class="n">outcome</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">new_state_name</span>
</div>
<div class="viewcode-block" id="Exploration.delete_state"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.delete_state">[docs]</a>    <span class="k">def</span> <span class="nf">delete_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes the given state.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;State </span><span class="si">%s</span><span class="s"> does not exist&#39;</span> <span class="o">%</span> <span class="n">state_name</span><span class="p">)</span>

        <span class="c"># Do not allow deletion of initial states.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span> <span class="o">==</span> <span class="n">state_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Cannot delete initial state of an exploration.&#39;</span><span class="p">)</span>

        <span class="c"># Find all destinations in the exploration which equal the deleted</span>
        <span class="c"># state, and change them to loop back to their containing state.</span>
        <span class="k">for</span> <span class="n">other_state_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="n">other_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">other_state_name</span><span class="p">]</span>
            <span class="n">all_outcomes</span> <span class="o">=</span> <span class="n">other_state</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">get_all_outcomes</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">all_outcomes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">dest</span> <span class="o">==</span> <span class="n">state_name</span><span class="p">:</span>
                    <span class="n">outcome</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">other_state_name</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">state_name</span><span class="p">]</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_states_v0_dict_to_v1_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">states_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts old states schema to the modern v1 schema. v1 contains the</span>
<span class="sd">        schema version 1 and does not contain any old constructs, such as</span>
<span class="sd">        widgets. This is a complete migration of everything previous to the</span>
<span class="sd">        schema versioning update to the earliest versioned schema.</span>

<span class="sd">        Note that the states_dict being passed in is modified in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># ensure widgets are renamed to be interactions</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">state_defn</span> <span class="ow">in</span> <span class="n">states_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;widget&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state_defn</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;widget&#39;</span><span class="p">])</span>
            <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
                <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">][</span><span class="s">&#39;widget_id&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">][</span><span class="s">&#39;widget_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;sticky&#39;</span> <span class="ow">in</span> <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">][</span><span class="s">&#39;sticky&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;widget&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">states_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_states_v1_dict_to_v2_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">states_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts from version 1 to 2. Version 1 assumes the existence of an</span>
<span class="sd">        implicit &#39;END&#39; state, but version 2 does not. As a result, the</span>
<span class="sd">        conversion process involves introducing a proper ending state for all</span>
<span class="sd">        explorations previously designed under this assumption.</span>

<span class="sd">        Note that the states_dict being passed in is modified in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># The name of the implicit END state before the migration. Needed here</span>
        <span class="c"># to migrate old explorations which expect that implicit END state.</span>
        <span class="n">_OLD_END_DEST</span> <span class="o">=</span> <span class="s">&#39;END&#39;</span>

        <span class="c"># Adds an explicit state called &#39;END&#39; with an EndExploration to replace</span>
        <span class="c"># links other states have to an implicit &#39;END&#39; state. Otherwise, if no</span>
        <span class="c"># states refer to a state called &#39;END&#39;, no new state will be introduced</span>
        <span class="c"># since it would be isolated from all other states in the graph and</span>
        <span class="c"># create additional warnings for the user. If they were not referring</span>
        <span class="c"># to an &#39;END&#39; state before, then they would only be receiving warnings</span>
        <span class="c"># about not being able to complete the exploration. The introduction of</span>
        <span class="c"># a real END state would produce additional warnings (state cannot be</span>
        <span class="c"># reached from other states, etc.)</span>
        <span class="n">targets_end_state</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">has_end_state</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">sdict</span><span class="p">)</span> <span class="ow">in</span> <span class="n">states_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_end_state</span> <span class="ow">and</span> <span class="n">state_name</span> <span class="o">==</span> <span class="n">_OLD_END_DEST</span><span class="p">:</span>
                <span class="n">has_end_state</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">targets_end_state</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">sdict</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">][</span><span class="s">&#39;handlers&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">rule_spec</span> <span class="ow">in</span> <span class="n">handler</span><span class="p">[</span><span class="s">&#39;rule_specs&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;dest&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">_OLD_END_DEST</span><span class="p">:</span>
                            <span class="n">targets_end_state</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">break</span>

        <span class="c"># Ensure any explorations pointing to an END state has a valid END</span>
        <span class="c"># state to end with (in case it expects an END state)</span>
        <span class="k">if</span> <span class="n">targets_end_state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_end_state</span><span class="p">:</span>
            <span class="n">states_dict</span><span class="p">[</span><span class="n">_OLD_END_DEST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;text&#39;</span><span class="p">,</span>
                    <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="s">&#39;Congratulations, you have finished!&#39;</span>
                <span class="p">}],</span>
                <span class="s">&#39;interaction&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="s">&#39;EndExploration&#39;</span><span class="p">,</span>
                    <span class="s">&#39;customization_args&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">&#39;recommendedExplorationIds&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="p">[]</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[{</span>
                        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;submit&#39;</span><span class="p">,</span>
                        <span class="s">&#39;rule_specs&#39;</span><span class="p">:</span> <span class="p">[{</span>
                            <span class="s">&#39;definition&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s">&#39;rule_type&#39;</span><span class="p">:</span> <span class="s">&#39;default&#39;</span>
                            <span class="p">},</span>
                            <span class="s">&#39;dest&#39;</span><span class="p">:</span> <span class="n">_OLD_END_DEST</span><span class="p">,</span>
                            <span class="s">&#39;feedback&#39;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s">&#39;param_changes&#39;</span><span class="p">:</span> <span class="p">[]</span>
                        <span class="p">}]</span>
                    <span class="p">}],</span>
                <span class="p">},</span>
                <span class="s">&#39;param_changes&#39;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">states_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_states_v2_dict_to_v3_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">states_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts from version 2 to 3. Version 3 introduces a triggers list</span>
<span class="sd">        within interactions.</span>

<span class="sd">        Note that the states_dict being passed in is modified in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Ensure all states interactions have a triggers list.</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">sdict</span><span class="p">)</span> <span class="ow">in</span> <span class="n">states_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">interaction</span> <span class="o">=</span> <span class="n">sdict</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;triggers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interaction</span><span class="p">:</span>
                <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;triggers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">states_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_states_v3_dict_to_v4_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">states_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts from version 3 to 4. Version 4 introduces a new structure</span>
<span class="sd">        for rules by organizing them into answer groups instead of handlers.</span>
<span class="sd">        This migration involves a 1:1 mapping from rule specs to answer groups</span>
<span class="sd">        containing just that single rule. Default rules have their destination</span>
<span class="sd">        state name and feedback copied to the default_outcome portion of an</span>
<span class="sd">        interaction instance.</span>

<span class="sd">        Note that the states_dict being passed in is modified in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">sdict</span><span class="p">)</span> <span class="ow">in</span> <span class="n">states_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">interaction</span> <span class="o">=</span> <span class="n">sdict</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">]</span>
            <span class="n">answer_groups</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">default_outcome</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;handlers&#39;</span><span class="p">]:</span>
                <span class="c"># Ensure the name is &#39;submit&#39;.</span>
                <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">handler</span> <span class="ow">and</span> <span class="n">handler</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;submit&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ExplorationConversionError</span><span class="p">(</span>
                        <span class="s">&#39;Error: Can only convert rules with a name &#39;</span>
                        <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">submit</span><span class="se">\&#39;</span><span class="s"> in states v3 to v4 conversion process. &#39;</span>
                        <span class="s">&#39;Encountered name: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">handler</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>

                <span class="c"># Each rule spec becomes a new answer group.</span>
                <span class="k">for</span> <span class="n">rule_spec</span> <span class="ow">in</span> <span class="n">handler</span><span class="p">[</span><span class="s">&#39;rule_specs&#39;</span><span class="p">]:</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="c"># Rules don&#39;t have a rule_type key anymore.</span>
                    <span class="n">is_default_rule</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="s">&#39;rule_type&#39;</span> <span class="ow">in</span> <span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;definition&#39;</span><span class="p">]:</span>
                        <span class="n">rule_type</span> <span class="o">=</span> <span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;definition&#39;</span><span class="p">][</span><span class="s">&#39;rule_type&#39;</span><span class="p">]</span>
                        <span class="n">is_default_rule</span> <span class="o">=</span> <span class="p">(</span><span class="n">rule_type</span> <span class="o">==</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

                        <span class="c"># Ensure the rule type is either default or atomic.</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_default_rule</span> <span class="ow">and</span> <span class="n">rule_type</span> <span class="o">!=</span> <span class="s">&#39;atomic&#39;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ExplorationConversionError</span><span class="p">(</span>
                                <span class="s">&#39;Error: Can only convert default and atomic &#39;</span>
                                <span class="s">&#39;rules in states v3 to v4 conversion process. &#39;</span>
                                <span class="s">&#39;Encountered rule of type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">rule_type</span><span class="p">)</span>

                    <span class="c"># Ensure the subject is answer.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;subject&#39;</span> <span class="ow">in</span> <span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;definition&#39;</span><span class="p">]</span> <span class="ow">and</span>
                            <span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;definition&#39;</span><span class="p">][</span><span class="s">&#39;subject&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;answer&#39;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ExplorationConversionError</span><span class="p">(</span>
                            <span class="s">&#39;Error: Can only convert rules with an </span><span class="se">\&#39;</span><span class="s">answer</span><span class="se">\&#39;</span><span class="s"> &#39;</span>
                            <span class="s">&#39;subject in states v3 to v4 conversion process. &#39;</span>
                            <span class="s">&#39;Encountered subject: </span><span class="si">%s</span><span class="s">&#39;</span>
                            <span class="o">%</span> <span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;definition&#39;</span><span class="p">][</span><span class="s">&#39;subject&#39;</span><span class="p">])</span>

                    <span class="c"># The rule turns into the group&#39;s only rule. Rules do not</span>
                    <span class="c"># have definitions anymore. Do not copy the inputs and name</span>
                    <span class="c"># if it is a default rule.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_default_rule</span><span class="p">:</span>
                        <span class="n">definition</span> <span class="o">=</span> <span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;definition&#39;</span><span class="p">]</span>
                        <span class="n">group</span><span class="p">[</span><span class="s">&#39;rule_specs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span>
                            <span class="s">&#39;inputs&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s">&#39;inputs&#39;</span><span class="p">]),</span>
                            <span class="s">&#39;rule_type&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
                        <span class="p">}]</span>

                    <span class="c"># Answer groups now have an outcome.</span>
                    <span class="n">group</span><span class="p">[</span><span class="s">&#39;outcome&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">&#39;dest&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;dest&#39;</span><span class="p">]),</span>
                        <span class="s">&#39;feedback&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;feedback&#39;</span><span class="p">]),</span>
                        <span class="s">&#39;param_changes&#39;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">rule_spec</span><span class="p">[</span><span class="s">&#39;param_changes&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="s">&#39;param_changes&#39;</span> <span class="ow">in</span> <span class="n">rule_spec</span> <span class="k">else</span> <span class="p">[])</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="n">is_default_rule</span><span class="p">:</span>
                        <span class="n">default_outcome</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s">&#39;outcome&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">answer_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

            <span class="n">is_terminal</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">interaction_registry</span><span class="o">.</span><span class="n">Registry</span><span class="o">.</span><span class="n">get_interaction_by_id</span><span class="p">(</span>
                    <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">is_terminal</span>
                    <span class="k">if</span> <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_terminal</span><span class="p">:</span>
                <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;answer_groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_groups</span>
                <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;default_outcome&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_outcome</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Terminal nodes have no answer groups or outcomes.</span>
                <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;answer_groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;default_outcome&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">del</span> <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;handlers&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">states_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_states_v4_dict_to_v5_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">states_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts from version 4 to 5. Version 5 removes the triggers list</span>
<span class="sd">        within interactions, and replaces it with a fallbacks list.</span>

<span class="sd">        Note that the states_dict being passed in is modified in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Ensure all states interactions have a fallbacks list.</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">sdict</span><span class="p">)</span> <span class="ow">in</span> <span class="n">states_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">interaction</span> <span class="o">=</span> <span class="n">sdict</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;triggers&#39;</span> <span class="ow">in</span> <span class="n">interaction</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;triggers&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;fallbacks&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interaction</span><span class="p">:</span>
                <span class="n">interaction</span><span class="p">[</span><span class="s">&#39;fallbacks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">states_dict</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Exploration.update_states_v0_to_v1_from_model"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_states_v0_to_v1_from_model">[docs]</a>    <span class="k">def</span> <span class="nf">update_states_v0_to_v1_from_model</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">versioned_exploration_states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts from states schema version 0 to 1 of the states blob</span>
<span class="sd">        contained in the versioned exploration states dict provided.</span>

<span class="sd">        Note that the versioned_exploration_states being passed in is modified</span>
<span class="sd">        in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states_schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">converted_states</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v0_dict_to_v1_dict</span><span class="p">(</span>
            <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converted_states</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Exploration.update_states_v1_to_v2_from_model"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_states_v1_to_v2_from_model">[docs]</a>    <span class="k">def</span> <span class="nf">update_states_v1_to_v2_from_model</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">versioned_exploration_states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts from states schema version 1 to 2 of the states blob</span>
<span class="sd">        contained in the versioned exploration states dict provided.</span>

<span class="sd">        Note that the versioned_exploration_states being passed in is modified</span>
<span class="sd">        in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states_schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">converted_states</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v1_dict_to_v2_dict</span><span class="p">(</span>
            <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converted_states</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Exploration.update_states_v2_to_v3_from_model"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_states_v2_to_v3_from_model">[docs]</a>    <span class="k">def</span> <span class="nf">update_states_v2_to_v3_from_model</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">versioned_exploration_states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts from states schema version 2 to 3 of the states blob</span>
<span class="sd">        contained in the versioned exploration states dict provided.</span>

<span class="sd">        Note that the versioned_exploration_states being passed in is modified</span>
<span class="sd">        in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states_schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">converted_states</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v2_dict_to_v3_dict</span><span class="p">(</span>
            <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converted_states</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Exploration.update_states_v3_to_v4_from_model"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_states_v3_to_v4_from_model">[docs]</a>    <span class="k">def</span> <span class="nf">update_states_v3_to_v4_from_model</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">versioned_exploration_states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts from states schema version 3 to 4 of the states blob</span>
<span class="sd">        contained in the versioned exploration states dict provided.</span>

<span class="sd">        Note that the versioned_exploration_states being passed in is modified</span>
<span class="sd">        in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states_schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">converted_states</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v3_dict_to_v4_dict</span><span class="p">(</span>
            <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converted_states</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Exploration.update_states_v4_to_v5_from_model"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.update_states_v4_to_v5_from_model">[docs]</a>    <span class="k">def</span> <span class="nf">update_states_v4_to_v5_from_model</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">versioned_exploration_states</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts from states schema version 4 to 5 of the states blob</span>
<span class="sd">        contained in the versioned exploration states dict provided.</span>

<span class="sd">        Note that the versioned_exploration_states being passed in is modified</span>
<span class="sd">        in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states_schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">converted_states</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v4_dict_to_v5_dict</span><span class="p">(</span>
            <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>
        <span class="n">versioned_exploration_states</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converted_states</span>

    <span class="c"># The current version of the exploration YAML schema. If any backward-</span>
    <span class="c"># incompatible changes are made to the exploration schema in the YAML</span>
    <span class="c"># definitions, this version number must be changed and a migration process</span>
    <span class="c"># put in place.</span></div>
    <span class="n">CURRENT_EXPLORATION_SCHEMA_VERSION</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_v1_dict_to_v2_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exploration_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a v1 exploration dict into a v2 exploration dict.&quot;&quot;&quot;</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;init_state_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">])</span>

        <span class="n">states_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]:</span>
            <span class="n">states_dict</span><span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">state</span>
            <span class="k">del</span> <span class="n">states_dict</span><span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]][</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">states_dict</span>

        <span class="k">return</span> <span class="n">exploration_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_v2_dict_to_v3_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exploration_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a v2 exploration dict into a v3 exploration dict.&quot;&quot;&quot;</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;objective&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;language_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_LANGUAGE_CODE</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;skill_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;blurb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;author_notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">exploration_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_v3_dict_to_v4_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exploration_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a v3 exploration dict into a v4 exploration dict.&quot;&quot;&quot;</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">state_defn</span> <span class="ow">in</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;widget&#39;</span><span class="p">])</span>
            <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
                <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">][</span><span class="s">&#39;widget_id&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">][</span><span class="s">&#39;widget_id&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;interaction&#39;</span><span class="p">][</span><span class="s">&#39;sticky&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">state_defn</span><span class="p">[</span><span class="s">&#39;widget&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">exploration_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_v4_dict_to_v5_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exploration_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a v4 exploration dict into a v5 exploration dict.&quot;&quot;&quot;</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="c"># Rename the &#39;skill_tags&#39; field to &#39;tags&#39;.</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;skill_tags&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;skill_tags&#39;</span><span class="p">]</span>

        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;skin_customizations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_SKIN_CUSTOMIZATIONS</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">exploration_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_v5_dict_to_v6_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exploration_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a v5 exploration dict into a v6 exploration dict.&quot;&quot;&quot;</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="c"># Ensure this exploration is up-to-date with states schema v3.</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v0_dict_to_v1_dict</span><span class="p">(</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v1_dict_to_v2_dict</span><span class="p">(</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v2_dict_to_v3_dict</span><span class="p">(</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>

        <span class="c"># Update the states schema version to reflect the above conversions to</span>
        <span class="c"># the states dict.</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states_schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">return</span> <span class="n">exploration_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_v6_dict_to_v7_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exploration_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a v6 exploration dict into a v7 exploration dict.&quot;&quot;&quot;</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>

        <span class="c"># Ensure this exploration is up-to-date with states schema v4.</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v3_dict_to_v4_dict</span><span class="p">(</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>

        <span class="c"># Update the states schema version to reflect the above conversions to</span>
        <span class="c"># the states dict.</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states_schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="k">return</span> <span class="n">exploration_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_convert_v7_dict_to_v8_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exploration_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a v7 exploration dict into a v8 exploration dict.&quot;&quot;&quot;</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="c"># Ensure this exploration is up-to-date with states schema v5.</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_states_v4_dict_to_v5_dict</span><span class="p">(</span>
            <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states&#39;</span><span class="p">])</span>

        <span class="c"># Update the states schema version to reflect the above conversions to</span>
        <span class="c"># the states dict.</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;states_schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">return</span> <span class="n">exploration_dict</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Exploration.from_yaml"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.from_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">from_yaml</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">exploration_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">yaml_content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates and returns exploration from a YAML text string.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exploration_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dict_from_yaml</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&#39;Please ensure that you are uploading a YAML text file, not &#39;</span>
                <span class="s">&#39;a zip file. The YAML parser returned the following error: </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">exploration_schema_version</span> <span class="o">=</span> <span class="n">exploration_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;schema_version&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exploration_schema_version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid YAML file: no schema version specified.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">exploration_schema_version</span>
                <span class="o">&lt;=</span> <span class="n">cls</span><span class="o">.</span><span class="n">CURRENT_EXPLORATION_SCHEMA_VERSION</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&#39;Sorry, we can only process v1 to v</span><span class="si">%s</span><span class="s"> YAML files at &#39;</span>
                <span class="s">&#39;present.&#39;</span> <span class="o">%</span> <span class="n">cls</span><span class="o">.</span><span class="n">CURRENT_EXPLORATION_SCHEMA_VERSION</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exploration_schema_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">exploration_dict</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_v1_dict_to_v2_dict</span><span class="p">(</span>
                <span class="n">exploration_dict</span><span class="p">)</span>
            <span class="n">exploration_schema_version</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">exploration_schema_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">exploration_dict</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_v2_dict_to_v3_dict</span><span class="p">(</span>
                <span class="n">exploration_dict</span><span class="p">)</span>
            <span class="n">exploration_schema_version</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="n">exploration_schema_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">exploration_dict</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_v3_dict_to_v4_dict</span><span class="p">(</span>
                <span class="n">exploration_dict</span><span class="p">)</span>
            <span class="n">exploration_schema_version</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="n">exploration_schema_version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">exploration_dict</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_v4_dict_to_v5_dict</span><span class="p">(</span>
                <span class="n">exploration_dict</span><span class="p">)</span>
            <span class="n">exploration_schema_version</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="n">exploration_schema_version</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">exploration_dict</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_v5_dict_to_v6_dict</span><span class="p">(</span>
                <span class="n">exploration_dict</span><span class="p">)</span>
            <span class="n">exploration_schema_version</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="k">if</span> <span class="n">exploration_schema_version</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">exploration_dict</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_v6_dict_to_v7_dict</span><span class="p">(</span>
                <span class="n">exploration_dict</span><span class="p">)</span>
            <span class="n">exploration_schema_version</span> <span class="o">=</span> <span class="mi">7</span>

        <span class="k">if</span> <span class="n">exploration_schema_version</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">exploration_dict</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_convert_v7_dict_to_v8_dict</span><span class="p">(</span>
                <span class="n">exploration_dict</span><span class="p">)</span>
            <span class="n">exploration_schema_version</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exploration_id</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="n">exploration_dict</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category</span>

        <span class="k">return</span> <span class="n">Exploration</span><span class="o">.</span><span class="n">create_exploration_from_dict</span><span class="p">(</span><span class="n">exploration_dict</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Exploration.to_yaml"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.to_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">exp_dict</span><span class="p">[</span><span class="s">&#39;schema_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_EXPLORATION_SCHEMA_VERSION</span>

        <span class="c"># Remove elements from the exploration dictionary that should not be</span>
        <span class="c"># saved within the YAML representation.</span>
        <span class="k">del</span> <span class="n">exp_dict</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">exp_dict</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">exp_dict</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">yaml_from_dict</span><span class="p">(</span><span class="n">exp_dict</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Exploration.to_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a copy of the exploration as a dictionary. It includes all</span>
<span class="sd">        necessary information to represent the exploration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">({</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s">&#39;category&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
            <span class="s">&#39;author_notes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_notes</span><span class="p">,</span>
            <span class="s">&#39;blurb&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">blurb</span><span class="p">,</span>
            <span class="s">&#39;default_skin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_skin</span><span class="p">,</span>
            <span class="s">&#39;states_schema_version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">states_schema_version</span><span class="p">,</span>
            <span class="s">&#39;init_state_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span><span class="p">,</span>
            <span class="s">&#39;language_code&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_code</span><span class="p">,</span>
            <span class="s">&#39;objective&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
            <span class="s">&#39;param_changes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_change_dicts</span><span class="p">,</span>
            <span class="s">&#39;param_specs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_specs_dict</span><span class="p">,</span>
            <span class="s">&#39;tags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="s">&#39;skin_customizations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">skin_instance</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span>
                <span class="s">&#39;skin_customizations&#39;</span><span class="p">],</span>
            <span class="s">&#39;states&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">state_name</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                       <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()}</span>
        <span class="p">})</span>
</div>
<div class="viewcode-block" id="Exploration.to_player_dict"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.to_player_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_player_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a copy of the exploration suitable for inclusion in the</span>
<span class="sd">        learner view.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;init_state_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state_name</span><span class="p">,</span>
            <span class="s">&#39;param_changes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_change_dicts</span><span class="p">,</span>
            <span class="s">&#39;param_specs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_specs_dict</span><span class="p">,</span>
            <span class="s">&#39;skin_customizations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">skin_instance</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span>
                <span class="s">&#39;skin_customizations&#39;</span><span class="p">],</span>
            <span class="s">&#39;states&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">state_name</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">}</span>
</div>
<div class="viewcode-block" id="Exploration.get_gadget_ids"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.get_gadget_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_gadget_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all gadget ids used in this exploration.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">gadget_instances_list</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skin_instance</span><span class="o">.</span><span class="n">panel_contents_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">([</span>
                <span class="n">gadget_instance</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">gadget_instance</span>
                <span class="ow">in</span> <span class="n">gadget_instances_list</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Exploration.get_interaction_ids"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.Exploration.get_interaction_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_interaction_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all interaction ids used in this exploration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span>
            <span class="n">state</span><span class="o">.</span><span class="n">interaction</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()]))</span>

</div></div>
<div class="viewcode-block" id="ExplorationSummary"><a class="viewcode-back" href="../../../../oppia.core.domain.html#oppia.core.domain.exp_domain.ExplorationSummary">[docs]</a><span class="k">class</span> <span class="nc">ExplorationSummary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Domain object for an Oppia exploration summary.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exploration_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span>
                 <span class="n">language_code</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                 <span class="n">community_owned</span><span class="p">,</span> <span class="n">owner_ids</span><span class="p">,</span> <span class="n">editor_ids</span><span class="p">,</span>
                 <span class="n">viewer_ids</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">exploration_model_created_on</span><span class="p">,</span>
                 <span class="n">exploration_model_last_updated</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&#39;ratings&#39; is a dict whose keys are &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39; and whose</span>
<span class="sd">        values are nonnegative integers representing frequency counts. Note</span>
<span class="sd">        that the keys need to be strings in order for this dict to be</span>
<span class="sd">        JSON-serializable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_get_thumbnail_image_url</span><span class="p">(</span><span class="n">category</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;/images/gallery/exploration_background_</span><span class="si">%s</span><span class="s">_small.png&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">feconf</span><span class="o">.</span><span class="n">CATEGORIES_TO_COLORS</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="k">if</span>
                <span class="n">category</span> <span class="ow">in</span> <span class="n">feconf</span><span class="o">.</span><span class="n">CATEGORIES_TO_COLORS</span> <span class="k">else</span>
                <span class="n">feconf</span><span class="o">.</span><span class="n">DEFAULT_COLOR</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">exploration_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language_code</span> <span class="o">=</span> <span class="n">language_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">community_owned</span> <span class="o">=</span> <span class="n">community_owned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owner_ids</span> <span class="o">=</span> <span class="n">owner_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editor_ids</span> <span class="o">=</span> <span class="n">editor_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer_ids</span> <span class="o">=</span> <span class="n">viewer_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploration_model_created_on</span> <span class="o">=</span> <span class="n">exploration_model_created_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploration_model_last_updated</span> <span class="o">=</span> <span class="n">exploration_model_last_updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_image_url</span> <span class="o">=</span> <span class="n">_get_thumbnail_image_url</span><span class="p">(</span><span class="n">category</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, The Oppia Authors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>